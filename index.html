<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deriv Account Balances</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2a3042;
            text-align: center;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e5eb;
            border-radius: 8px;
        }
        button {
            background-color: #ff444f;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            margin: 20px auto;
            width: 200px;
        }
        button:hover {
            background-color: #e63b45;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .account-card {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .account-real {
            border-left: 4px solid #4CAF50;
        }
        .account-virtual {
            border-left: 4px solid #2196F3;
        }
        .balance {
            font-size: 18px;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 4px;
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
        .info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        .account-details {
            flex-grow: 1;
        }
        .account-meta {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Deriv Account Balances</h1>
        
        <div class="info">
            <h3>Account Information</h3>
            <div id="url-params-display"></div>
        </div>
        
        <div class="section" id="auth-section">
            <h2>Step 1: Authenticate with Deriv</h2>
            <p>Click the button below to log in with your Deriv account.</p>
            <button id="login-btn">Login with Deriv</button>
        </div>
        
        <div class="section hidden" id="balances-section">
            <h2>Your Account Balances</h2>
            <div id="accounts-container"></div>
            <button id="refresh-btn">Refresh Balances</button>
        </div>
        
        <div id="error-message" class="error hidden"></div>
    </div>

    <script>
        // Configuration
        const APP_ID = '70894';
        const REDIRECT_URI = window.location.href.split('?')[0];
        
        // DOM elements
        const loginBtn = document.getElementById('login-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const authSection = document.getElementById('auth-section');
        const balancesSection = document.getElementById('balances-section');
        const accountsContainer = document.getElementById('accounts-container');
        const errorMessage = document.getElementById('error-message');
        const urlParamsDisplay = document.getElementById('url-params-display');
        
        // State
        let accessToken = null;
        let accountData = {};
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Display URL parameters if they exist
            displayUrlParameters();
            
            // Check for existing tokens in URL
            const urlParams = new URLSearchParams(window.location.search);
            const token1 = urlParams.get('token1');
            const token2 = urlParams.get('token2');
            
            if (token1 || token2) {
                // We have tokens in the URL - process them
                processUrlTokens();
            } else {
                // Check for OAuth code
                const authCode = urlParams.get('code');
                if (authCode) {
                    handleAuthorizationCode(authCode);
                }
            }
            
            // Set up event listeners
            loginBtn.addEventListener('click', initiateOAuthFlow);
            refreshBtn.addEventListener('click', fetchAccountBalances);
        });
        
        // Display URL parameters
        function displayUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            let paramsHtml = '<ul>';
            
            urlParams.forEach((value, key) => {
                paramsHtml += `<li><strong>${key}:</strong> ${value}</li>`;
            });
            
            paramsHtml += '</ul>';
            urlParamsDisplay.innerHTML = paramsHtml;
        }
        
        // Process tokens from URL
        function processUrlTokens() {
            const urlParams = new URLSearchParams(window.location.search);
            
            accountData = {
                realAccount: {
                    accountId: urlParams.get('acct1'),
                    token: urlParams.get('token1'),
                    currency: urlParams.get('cur1')
                },
                virtualAccount: {
                    accountId: urlParams.get('acct2'),
                    token: urlParams.get('token2'),
                    currency: urlParams.get('cur2')
                }
            };
            
            // Show balances section
            authSection.classList.add('hidden');
            balancesSection.classList.remove('hidden');
            
            // Fetch account balances
            fetchAccountBalances();
        }
        
        // Start the OAuth flow
        function initiateOAuthFlow() {
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading"></span> Redirecting...';
            
            const authUrl = new URL('https://oauth.deriv.com/oauth2/authorize');
            authUrl.searchParams.append('app_id', APP_ID);
            authUrl.searchParams.append('redirect_uri', REDIRECT_URI);
            
            window.location.href = authUrl.toString();
        }
        
        // Handle authorization code
        async function handleAuthorizationCode(authCode) {
            try {
                loginBtn.innerHTML = '<span class="loading"></span> Authenticating...';
                
                // Simulate token exchange
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Mock response
                const tokenResponse = {
                    access_token: 'mock_access_token_' + Math.random().toString(36).substring(2),
                    refresh_token: 'mock_refresh_token_' + Math.random().toString(36).substring(2),
                    expires_in: 3600,
                    token_type: 'Bearer'
                };
                
                accessToken = tokenResponse.access_token;
                
                // Mock account data
                accountData = {
                    realAccount: {
                        accountId: 'CR' + Math.floor(1000000 + Math.random() * 9000000),
                        token: 'a1-' + Math.random().toString(36).substring(2, 15),
                        currency: 'USD',
                        balance: null
                    },
                    virtualAccount: {
                        accountId: 'VRTC' + Math.floor(10000000 + Math.random() * 90000000),
                        token: 'a1-' + Math.random().toString(36).substring(2, 15),
                        currency: 'USD',
                        balance: null
                    }
                };
                
                // Show balances section
                authSection.classList.add('hidden');
                balancesSection.classList.remove('hidden');
                
                // Fetch account balances
                await fetchAccountBalances();
                
            } catch (error) {
                showError('Authentication failed: ' + error.message);
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Login with Deriv';
            }
        }
        
        // Fetch account balances with error handling
        async function fetchAccountBalances() {
            try {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<span class="loading"></span> Loading...';
                accountsContainer.innerHTML = '';
                
                // Clear previous errors
                errorMessage.classList.add('hidden');
                
                // Fetch both balances in parallel
                const [realBalance, virtualBalance] = await Promise.all([
                    fetchBalance(accountData.realAccount).catch(error => {
                        console.error('Failed to fetch Real balance:', error);
                        return { error: 'Failed to fetch Real balance' };
                    }),
                    fetchBalance(accountData.virtualAccount).catch(error => {
                        console.error('Failed to fetch Virtual balance:', error);
                        return { error: 'Failed to fetch Virtual balance' };
                    })
                ]);
                
                // Update account data with balances or errors
                if (!realBalance.error) {
                    accountData.realAccount.balance = realBalance.balance;
                } else {
                    accountData.realAccount.balance = realBalance.error;
                }
                
                if (!virtualBalance.error) {
                    accountData.virtualAccount.balance = virtualBalance.balance;
                } else {
                    accountData.virtualAccount.balance = virtualBalance.error;
                }
                
                // Display accounts
                displayAccounts();
                
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'Refresh Balances';
                
            } catch (error) {
                showError('Failed to fetch balances: ' + error.message);
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'Refresh Balances';
            }
        }
        
        // Simulate fetching balance from Deriv API
        async function fetchBalance(account) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // Simulate occasional 500 errors (20% chance)
            if (Math.random() < 0.2) {
                throw new Error(`HTTP error! status: 500`);
            }
            
            // Return mock balance
            return {
                balance: (Math.random() * 10000).toFixed(2),
                currency: account.currency
            };
        }
        
        // Display accounts with their balances
        function displayAccounts() {
            // Real Account
            const realCard = document.createElement('div');
            realCard.className = 'account-card account-real';
            realCard.innerHTML = `
                <div class="account-details">
                    <div class="account-type">Real Account</div>
                    <div>${accountData.realAccount.accountId}</div>
                    <div class="account-meta">Token: ${accountData.realAccount.token}</div>
                    <div class="account-meta">Currency: ${accountData.realAccount.currency}</div>
                </div>
                <div class="balance">
                    ${typeof accountData.realAccount.balance === 'string' ? 
                      `<span style="color:red">${accountData.realAccount.balance}</span>` : 
                      accountData.realAccount.balance} ${accountData.realAccount.currency}
                </div>
            `;
            accountsContainer.appendChild(realCard);
            
            // Virtual Account
            const virtualCard = document.createElement('div');
            virtualCard.className = 'account-card account-virtual';
            virtualCard.innerHTML = `
                <div class="account-details">
                    <div class="account-type">Virtual Account</div>
                    <div>${accountData.virtualAccount.accountId}</div>
                    <div class="account-meta">Token: ${accountData.virtualAccount.token}</div>
                    <div class="account-meta">Currency: ${accountData.virtualAccount.currency}</div>
                </div>
                <div class="balance">
                    ${typeof accountData.virtualAccount.balance === 'string' ? 
                      `<span style="color:red">${accountData.virtualAccount.balance}</span>` : 
                      accountData.virtualAccount.balance} ${accountData.virtualAccount.currency}
                </div>
            `;
            accountsContainer.appendChild(virtualCard);
        }
        
        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => errorMessage.classList.add('hidden'), 5000);
        }
    </script>
</body>
</html>
